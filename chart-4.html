<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Kariapper Family Tree ‚Äì chart-5</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="d3.min.js"></script>
  <style>
    body { margin: 0; font-family: "Segoe UI", sans-serif; }
    h1   { text-align: center; margin: 12px 0; }
    #controls { text-align: center; margin: 10px; }
    #tree_div { width: 100%; height: calc(100vh - 100px); overflow: auto; }
    svg { display: block; width: 100%; height: auto; }

    .trunk,.branch{fill:none;stroke:#888;stroke-width:1.5px;stroke-linecap:round}
    .marriage-link { fill:none; stroke:#d66; stroke-width:1.5px; }
    .node-rect{rx:4;ry:4;filter:drop-shadow(2px 2px 2px rgba(0,0,0,.15))}
    .gen1{fill:#eceff4;stroke:#4c566a}
    .gen2{fill:#e5e9f0;stroke:#3b4252}
    .gen3{fill:#d8dee9;stroke:#2e3440}
    .female{fill:#fbd3e0!important}
    .male  {fill:#d0e4f7!important}
    .deceased { stroke: green !important; }

    .node-text{pointer-events:none;text-anchor:start;dominant-baseline:central}
    .node{cursor:pointer}
    .tooltip{paint-order:stroke;font:13px sans-serif;fill:#333;stroke:#fff;
             stroke-width:.5;pointer-events:none}
    #btnReset{margin-left:6px;font-size:.9em;opacity:.75}
    #btnZoomIn{margin-left:20px;font-size:.9em;opacity:.75}
  </style>
</head>
<body>
  <h1>Kariapper Family Tree ‚Äì chart-A</h1>
  <div id="controls">
    <button onclick="toggleGen3()">Toggle Gen-3</button>
    <button id="btnZoomIn">Ôºã</button>
    <button id="btnZoomOut">Ôºç</button>
    <button id="btnReset">Reset View</button>
    <button id="save-svg-btn" style="padding:6px 18px; font-size:16px;">üíæ Save SVG</button>
  </div>
  <div style="text-align:center;margin-top:8px">
    <button onclick="window.location.reload()" style="padding:6px 18px;font-size:16px">
      üîÑ Refresh
    </button>
  </div>
  <div id="tree_div">Loading‚Ä¶</div>

<script>
(async function () {
  const sheetID = '1BE7PJAJs3QxHnOsb1z5cKnGHdjQCR8IksorMcAm7Fx8';
  const raw = await fetch(
    `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?gid=0&headers=1&tqx=out:json`
  ).then(r => r.text());
  const json = JSON.parse(raw.slice(raw.indexOf('(') + 1, raw.lastIndexOf(')')));
  const headers = json.table.cols.map(c => c.label);
  const rows = json.table.rows;

  // find the key columns:
  const idIdx    = headers.findIndex(h=>/\(dID\)$/i.test(h));
  const nameIdx  = headers.findIndex(h=>h.trim() === 'Full Name');
  const genIdx   = headers.findIndex(h=>/^generation$/i.test(h));
  const genderIdx= headers.findIndex(h=>/^gender$/i.test(h.trim().toLowerCase()));
  const dodIdx   = headers.findIndex(h=>/\bdeath.*date\b/i.test(h) || h==='M');

  // Collect all spouse-dID columns:
  const spouseCols = headers
    .map((h,i) => i)
    .filter(i => /\(dID\)$/i.test(headers[i]) && /spouse/i.test(headers[i]));

  if([idIdx,nameIdx,genIdx].some(i=>i<0)){
    document.getElementById('tree_div').textContent = '‚ùå missing required columns';
    return;
  }

  // build flat array
  const flat = rows.map(r => {
    const id   = r.c[idIdx]?.v||'';
    const name = r.c[nameIdx]?.v||'';
    const gen  = +r.c[genIdx]?.v;
    const genderRaw = genderIdx>=0 ? (r.c[genderIdx]?.v||'').toLowerCase() : '';
    const gender = genderRaw.startsWith('f')?'f':genderRaw.startsWith('m')?'m':'';
    const dod = dodIdx>=0 ? (r.c[dodIdx]?.v||'') : '';
    const spouses = spouseCols
      .map(i => r.c[i]?.v)
      .filter(v=>v);
    const parent = id.includes('.') ? id.replace(/\.[^.]+$/, '') : '';
    return { id, name, gen, gender, dod, parent, spouses, children: [] };
  })
  .filter(d=>d.id && d.name && Number.isFinite(d.gen));

  // index lookup
  const byId = Object.fromEntries(flat.map(d=>[d.id,d]));
  flat.forEach(d => {
    if(d.parent && byId[d.parent]){
      byId[d.parent].children.push(d);
    }
  });

  const rootData = byId['ALK'];
  if(!rootData){
    document.getElementById('tree_div').textContent = '‚ùå root ALK not found';
    return;
  }

  // spacing
  const charW       = 9;
  const maxLabelLen = d3.max(flat, d => (d.name+' '+d.id).length);
  const hSpacing    = Math.max(180, maxLabelLen*charW+50);
  const vSpacing    = 40;
  const stub        = 20;
  const indent      = 12;

  // hierarchy & layout
  const root = d3.hierarchy(rootData, d=>d.children);
  const tree = d3.tree().nodeSize([vSpacing,hSpacing]);

  // initial collapse: hide children of gen-3 and deeper
  root.descendants().forEach(d => {
    if(d.data.gen >= 3 && d.children){
      d._children = d.children;
      d.children  = null;
    }
  });

  const svg    = d3.select('#tree_div').html('').append('svg')
                     .attr('preserveAspectRatio','xMinYMin meet');
  const gZoom  = svg.append('g');
  const g      = gZoom.append('g');

  // zoom & pan
  const zoomBehavior = d3.zoom()
    .scaleExtent([0.5,2])
    .on('zoom', ({transform}) => gZoom.attr('transform',transform));
  svg.call(zoomBehavior);

  const zoomStep = 1.25;
  d3.select('#btnZoomIn' ).on('click',()=>svg.transition().call(zoomBehavior.scaleBy, zoomStep));
  d3.select('#btnZoomOut').on('click',()=>svg.transition().call(zoomBehavior.scaleBy, 1/zoomStep));
  d3.select('#btnReset'  ).on('click',()=>svg.transition().call(zoomBehavior.transform,d3.zoomIdentity));

  window.centerView = () => svg.transition().duration(0)
                               .call(zoomBehavior.transform, d3.zoomIdentity);

  const tooltip = g.append('text')
                   .attr('class','tooltip')
                   .style('display','none');

  function toggle(_,d){
    if(d.data.gen >= 3){
      if(d.children){
        d._children = d.children;
        d.children  = null;
      } else {
        d.children  = d._children;
        d._children = null;
      }
      update();
      centerView();
    }
  }

  // build marriage links
  const marriageLinks = [];
  flat.forEach(p => {
    p.spouses.forEach(sID => {
      if(byId[sID] && p.id < sID){
        marriageLinks.push({source:p.id, target:sID});
      }
    });
  });

  function update(){
    tree(root);

    const alignedX = d3.max(
      root.descendants().filter(d=>(d.children||d._children)?.length),
      d=>{
        const icon = d.data.gender==='f'?' ‚ôÄ':d.data.gender==='m'?' ‚ôÇ':'';
        const label = d.data.name + icon + ' ' + d.data.id;
        return d.y + Math.max(80,label.length*charW+20)/2 + stub;
      }
    )||0;

    const xs = root.descendants().map(d=>d.x);
    const ys = root.descendants().map(d=>d.y).concat(alignedX);
    const M  = 100;
    const minX = Math.min(...xs), maxX=Math.max(...xs);
    const minY = Math.min(...ys), maxY=Math.max(...ys);
    svg.attr('viewBox',[0,0,(maxY-minY)+M*2,(maxX-minX)+M*2].join(' '));
    g.attr('transform',`translate(${M-minY},${M-minX})`);

    // trunks
    g.selectAll('path.trunk')
      .data(root.descendants().filter(d=>d.children?.length), d=>d.data.id)
      .join('path').attr('class','trunk')
      .attr('d', d=>{
        const icon = d.data.gender==='f'?' ‚ôÄ':d.data.gender==='m'?' ‚ôÇ':'';
        const label = d.data.name + icon + ' ' + d.data.id;
        const w = Math.max(80,label.length*charW+20);
        const px = d.y + w/2 + (d.depth===0?indent:0);
        const tx = d.depth===1 ? alignedX : px+stub;
        const ys = d.children.map(c=>c.x);
        return `M${px},${d.x}H${tx}M${tx},${d3.min(ys)}V${d3.max(ys)}`;
      });

    // branches
    g.selectAll('path.branch')
      .data(root.links(), d=>d.target.data.id)
      .join('path').attr('class','branch')
      .attr('d', d=>{
        const sIcon = d.source.data.gender==='f'?' ‚ôÄ':d.source.data.gender==='m'?' ‚ôÇ':'';
        const sLabel= d.source.data.name + sIcon + ' ' + d.source.data.id;
        const srcW = Math.max(80,sLabel.length*charW+20);
        const parentX = d.source.depth===1
          ? alignedX
          : d.source.y + srcW/2 + stub + (d.source.depth===0?indent:0);

        const tIcon = d.target.data.gender==='f'?' ‚ôÄ':d.target.data.gender==='m'?' ‚ôÇ':'';
        const tLabel= d.target.data.name + tIcon + ' ' + d.target.data.id;
        const trgW = Math.max(80,tLabel.length*charW+20);
        const childTrunkX = d.target.depth===2
          ? alignedX
          : d.target.y + trgW/2 + stub;
        const hasKids = (d.target.children||d.target._children)?.length;
        const endX = hasKids ? childTrunkX : parentX+indent;
        return `M${parentX},${d.target.x}H${endX}`;
      });

    // marriage links
    g.selectAll('path.marriage-link')
      .data(marriageLinks, d=>d.source+'-'+d.target)
      .join('path').attr('class','marriage-link')
      .attr('d', d=>{
        const a = byId[d.source], b = byId[d.target];
        const ndA = root.descendants().find(n=>n.data.id===a.id);
        const ndB = root.descendants().find(n=>n.data.id===b.id);
        if(!ndA||!ndB) return '';
        const x1=ndA.x, y1=ndA.y;
        const x2=ndB.x, y2=ndB.y;
        const midY = Math.min(x1,x2)-30;
        return `M${y1},${x1} Q${(y1+y2)/2},${midY} ${y2},${x2}`;
      });

    // nodes
    const nodes = g.selectAll('g.node')
      .data(root.descendants(), d=>d.data.id)
      .join(enter=>{
        const n = enter.append('g')
          .attr('class','node')
          .on('click',toggle);
        n.append('rect');
        n.append('text');
        return n;
      });

    nodes.each(function(d){
      const n = d3.select(this);
      const icon = d.data.gender==='f'?' ‚ôÄ':d.data.gender==='m'?' ‚ôÇ':'';
      const label= d.data.name+icon+' '+d.data.id;
      const w    = Math.max(80,label.length*charW+20);

      const parent = d.parent;
      const parentLabel = parent
        ? parent.data.name + (parent.data.gender==='f'?' ‚ôÄ':parent.data.gender==='m'?' ‚ôÇ':'') + ' ' + parent.data.id
        : '';
      const parentW = Math.max(80,parentLabel.length*charW+20);
      const baseX = parent
        ? (parent.depth===1
            ? alignedX
            : parent.y + parentW/2 + stub + (parent.depth===0?indent:0))
        : d.y - w/2;
      const extra = d.depth===1 ? indent : 0;
      const genderClass = d.data.gender==='f' ? 'female' : d.data.gender==='m' ? 'male' : '';
      const deathClass  = d.data.dod ? ' deceased' : '';

      n.attr('transform',`translate(${baseX+indent+extra},${d.x})`);
      n.select('rect')
       .attr('class',`node-rect gen${d.data.gen} ${genderClass}${deathClass}`)
       .attr('x',0).attr('y',-12)
       .attr('width',w).attr('height',24);
      n.select('text')
       .attr('class','node-text')
       .attr('x',10).attr('y',0)
       .text(label);

      n.on('mouseover',()=>{
        const spouses = d.data.spouses.length
          ? d.data.spouses.join(', ')
          : 'none';
        tooltip.text('Spouse(s): ' + spouses)
               .attr('x', baseX+indent+5)
               .attr('y', d.x-18)
               .style('display','block');
      }).on('mouseout',()=>{
        tooltip.style('display','none');
      });
    });
  }

  update();

  // toggle Gen-3
  let collapsed = true;
  window.toggleGen3 = function(){
    root.descendants().forEach(d=>{
      if(d.data.gen >= 3){
        if(collapsed && d._children){
          d.children = d._children; d._children = null;
        } else if(!collapsed && d.children){
          d._children = d.children; d.children = null;
        }
      }
    });
    collapsed = !collapsed;
    update();
    centerView();
  };
})();

// save SVG
document.getElementById('save-svg-btn').onclick = function () {
  const svg = document.querySelector('#tree_div svg');
  if (!svg) { alert('No SVG to save'); return; }
  const css = `
    .trunk, .branch { fill:none; stroke:#888; stroke-width:1.5px; stroke-linecap:round; }
    .marriage-link { fill:none; stroke:#d66; stroke-width:1.5px; }
    .node-rect { rx:4; ry:4; filter:drop-shadow(2px 2px 2px rgba(0,0,0,.15)); }
    .gen1 { fill:#eceff4; stroke:#4c566a; }
    .gen2 { fill:#e5e9f0; stroke:#3b4252; }
    .gen3 { fill:#d8dee9; stroke:#2e3440; }
    .female { fill:#fbd3e0!important; }
    .male   { fill:#d0e4f7!important; }
    .deceased { stroke: green!important; }
    .node-text { pointer-events:none; text-anchor:start; dominant-baseline:central; }
    .tooltip { paint-order:stroke; font:13px sans-serif; fill:#333; stroke:#fff; stroke-width:.5; pointer-events:none; }
  `;
  const clone = svg.cloneNode(true);
  const style = document.createElementNS('http://www.w3.org/2000/svg','style');
  style.textContent = "<![CDATA[\n" + css + "\n]]>";
  clone.insertBefore(style, clone.firstChild);
  clone.setAttribute('version','1.1');
  clone.setAttribute('xmlns','http://www.w3.org/2000/svg');
  clone.setAttribute('xmlns:xlink','http://www.w3.org/1999/xlink');
  const xml = new XMLSerializer().serializeToString(clone);
  const uri = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent('<?xml version="1.0"?>\n' + xml);
  const link = document.createElement('a');
  link.href = uri;
  link.download = 'family-tree.svg';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
};
</script>
</body>
</html>
