<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Kariapper Family Tree – up to 3 generations---diff</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    html, body { margin:0; padding:0; height:100%; }
    h1 { text-align:center; margin:12px 0; font-family:sans-serif; }
    #tree_div {
      width:100%;
      height:calc(100% - 48px);
      overflow:auto;
      box-sizing:border-box;
      padding:10px;
    }
    .org-node {
      padding:4px 8px;
      border-radius:4px;
      border:1px solid #666;
      background:#f9f9f9;
      font-family:Arial, sans-serif;
      text-align:center;
    }
  </style>
</head>
<body>
  <h1>Kariapper Family Tree – up to 3 generations---diff</h1>
  <div id="tree_div">Loading…</div>
  <script>
    google.charts.load('current',{packages:['orgchart']});
    google.charts.setOnLoadCallback(fetchAndDraw);

    function fetchAndDraw(){
      const sheetID   = '1BE7PJAJs3QxHnOsb1z5cKnGHdjQCR8IksorMcAm7Fx8';
      const sheetName = 'Master';            // ← your tab name
      const qry       = "select D, P, C, N, O where AA <= 3";
      const url = 
        `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq`
      + `?sheet=${sheetName}`
      + `&headers=1`
      + `&tq=${encodeURIComponent(qry)}`
      + `&tqx=out:json`;                          // ask for JSON

      fetch(url)
        .then(r=>r.text())
        .then(txt=>{
          // strip the JS wrapper around the JSON
          const json = JSON.parse(
            txt.slice(txt.indexOf('(')+1, txt.lastIndexOf(')'))
          );
          drawChart(json.table.rows);
        })
        .catch(err=>{
          console.error(err);
          document.getElementById('tree_div').innerText =
            'Error loading sheet – see console.';
        });
    }

    function drawChart(rows){
      const data = new google.visualization.DataTable();
      data.addColumn('string','Node');
      data.addColumn('string','Parent');
      data.addColumn({type:'string', role:'tooltip', p:{html:true}});

      // each row.c is an array of cells [D, P, C, N, O]
      rows.forEach(r=>{
        const id     = r.c[0]?.v || '';
        const parent = r.c[1]?.v || '';
        const name   = r.c[2]?.v || '';
        const spF    = r.c[3]?.v || '';
        const spM    = r.c[4]?.v || '';
        const spouses= [spF,spM].filter(s=>s).join(', ');

        const nodeHtml = `<div class="org-node">${name}</div>`;
        const tipHtml  = `<div style="padding:6px;">
                            <strong>${name}</strong>
                            ${spouses?`<br/><em>Spouse(s):</em> ${spouses}`:''}
                          </div>`;

        data.addRow([{v:id, f:nodeHtml}, parent, tipHtml]);
      });

      const chart = new google.visualization.OrgChart(
        document.getElementById('tree_div')
      );
      chart.draw(data,{
        allowHtml:     true,
        allowCollapse: true,
        compactRows:   true
      });
    }
  </script>
</body>
</html>
