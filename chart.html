<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Kariapper Family Tree – up to 3 generations</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    html, body { margin:0; padding:0; height:100%; }
    h1 { text-align:center; margin:12px 0; font-family:sans-serif; }
    #tree_div {
      width:100%; 
      height:calc(100% - 48px);
      overflow:auto;
      box-sizing:border-box;
      padding:10px;
    }
    .org-node {
      /* optional node styling */
      padding:4px 8px;
      border-radius:4px;
      border:1px solid #666;
      background:#f9f9f9;
      font-family:Arial, sans-serif;
    }
  </style>
</head>
<body>
  <h1>Kariapper Family Tree – up to 3 generations - NEW</h1>
  <div id="tree_div">Loading…</div>

  <script>
    // 1) Load the OrgChart package
    google.charts.load('current', {packages:['orgchart']});
    google.charts.setOnLoadCallback(drawChart);

    function drawChart() {
      // 2) Build the query URL (MasterSheet already published to web)
      const sheetID = '1BE7PJAJs3QxHnOsb1z5cKnGHdjQCR8IksorMcAm7Fx8';
      const queryText = "select D, P, C, N, O where AA <= 3";
      // D = dID, P = Father_dID, C = FullName, N = SpouseF, O = SpouseM, AA = Generation
      const base = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq`;
      const url = `${base}?sheet=Master&headers=1&tq=${encodeURIComponent(queryText)}`;

      const query = new google.visualization.Query(url);
      query.send(response => {
        if (response.isError()) {
          console.error('GViz error:', response.getMessage(), response.getDetailedMessage());
          document.getElementById('tree_div').innerText =
            'Error loading data – check console for details.';
          return;
        }

        // 3) Build a new DataTable with proper columns
        const raw = response.getDataTable();
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Name');
        data.addColumn('string', 'Parent');
        data.addColumn({ type:'string', role:'tooltip', p:{html:true} });

        // 4) Transform each row: use formatted value for node label
        for (let i = 0; i < raw.getNumberOfRows(); i++) {
          const id       = raw.getValue(i, 0);
          const parent   = raw.getValue(i, 1) || '';
          const fullName = raw.getValue(i, 2);
          const spouseF  = raw.getValue(i, 3) || '';
          const spouseM  = raw.getValue(i, 4) || '';
          const spouses  = [spouseF, spouseM].filter(s=>s).join(', ');

          // Node HTML for label
          const nodeHtml = `<div class="org-node">${fullName}</div>`;
          // Tooltip HTML for hover
          const tipHtml = `<div style="padding:6px;">
                             <strong>${fullName}</strong>
                             ${spouses ? `<br/><em>Spouse(s):</em> ${spouses}` : ''}
                           </div>`;

          data.addRow([
            { v: id, f: nodeHtml },
            parent,
            tipHtml
          ]);
        }

        // 5) Draw the chart, vertical orientation
        const chart = new google.visualization.OrgChart(
          document.getElementById('tree_div')
        );
        chart.draw(data, {
          allowHtml:     true,
          allowCollapse: true,
          orientation:   'vertical'
        });
      });
    }
  </script>
</body>
</html>
