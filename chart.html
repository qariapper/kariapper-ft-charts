<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Kariapper Family Tree</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body { margin: 0; font-family: "Segoe UI", sans-serif; }
    h1   { text-align: center; margin: 12px 0; }
    #controls { text-align: center; margin: 10px; }
    #tree_div { width: 100%; height: calc(100vh - 100px); overflow: auto; }
    svg { display: block; width: 100%; height: auto; }

    .trunk,.branch{fill:none;stroke:#888;stroke-width:1.5px;stroke-linecap:round}
    .node-rect{rx:4;ry:4;filter:drop-shadow(2px 2px 2px rgba(0,0,0,.15))}
    .gen1{fill:#eceff4;stroke:#4c566a}
    .gen2{fill:#e5e9f0;stroke:#3b4252}
    .gen3{fill:#d8dee9;stroke:#2e3440}
    .female{fill:#fbd3e0!important}
    .male  {fill:#d0e4f7!important}
    .deceased { stroke: green !important; }

    .node-text{pointer-events:none;text-anchor:start;dominant-baseline:central}
    .node{cursor:pointer}
    .stub-zone{fill:transparent;cursor:pointer}
    .tooltip{paint-order:stroke;font:13px sans-serif;fill:#333;stroke:#fff;
             stroke-width:.5;pointer-events:none}
    #btnReset{margin-left:6px;font-size:.9em;opacity:.75}
    #btnZoomIn{margin-left:20px;font-size:.9em;opacity:.75}
  </style>
</head>
<body>
  <h1>Kariapper Family Tree – up to 3 generations -zzz</h1>
  <div id="controls">
    <button onclick="toggleGen3()">Toggle Gen-3</button>
    <button id="btnZoomIn">＋</button>
    <button id="btnZoomOut">－</button>
    <button id="btnReset">Reset View</button>
  </div>
  <div id="tree_div">Loading…</div>

<script>
(async function () {
  const sheetID='1BE7PJAJs3QxHnOsb1z5cKnGHdjQCR8IksorMcAm7Fx8';
  const raw=await fetch(`https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?gid=0&headers=1&tqx=out:json`)
    .then(r=>r.text());
  const json=JSON.parse(raw.slice(raw.indexOf('(')+1,raw.lastIndexOf(')')));
  const headers=json.table.cols.map(c=>c.label);
  const rows=json.table.rows;

  const idIdx=headers.findIndex(h=>/\(dID\)$/i.test(h));
  const nameIdx=headers.findIndex(h=>h.trim()==='Full Name');
  const genIdx=headers.findIndex(h=>/^generation$/i.test(h));
  const spouseIdx=headers.findIndex(h=>h.trim().toLowerCase().startsWith('spouse'));
  const genderIdx=headers.findIndex(h=>h.trim().toLowerCase()==='gender');
  const dodIdx=12; // Column M

  if([idIdx,nameIdx,genIdx,spouseIdx].some(i=>i<0)){
    document.getElementById('tree_div').textContent='❌ missing columns';
    return;
  }

  const flat=rows.map(r=>{
    const id=r.c[idIdx]?.v||'', name=r.c[nameIdx]?.v||'',
          gen=+r.c[genIdx]?.v, spouse=r.c[spouseIdx]?.v||'';
    const graw=genderIdx>=0?r.c[genderIdx]?.v?.toLowerCase():'';
    const gender=graw.startsWith('f')?'f':graw.startsWith('m')?'m':'';
    const dod=r.c[dodIdx]?.v||'';
    return {
      id,name,gen,gender,dod,
      parent: id.includes('.')? id.replace(/\.[^.]+$/,'') : '',
      spouse, children:[]
    };
  }).filter(d=>d.id && d.name && Number.isFinite(d.gen) && d.gen<=3);

  const byId=Object.fromEntries(flat.map(d=>[d.id,d]));
  flat.forEach(d=>{ if(d.parent && byId[d.parent]) byId[d.parent].children.push(d) });
  const rootData=byId['ALK'];
  if(!rootData){
    document.getElementById('tree_div').textContent='❌ root ALK not found'; return;
  }

  const charW=9, indent=12, stub=20;
  const maxLabelLen=d3.max(flat,d=>(
    (d.name + (d.gender==='f'?' ♀':d.gender==='m'?' ♂':'') + ' ' + d.id).length
  ));
  const hSpacing=Math.max(180, maxLabelLen*charW+50), vSpacing=40;

  const root=d3.hierarchy(rootData,d=>d.children),
        tree=d3.tree().nodeSize([vSpacing,hSpacing]);

  // collapse gen-2 initially
  root.descendants().forEach(d=>{
    if(d.data.gen===2 && d.children){
      d._children=d.children; d.children=null;
    }
  });

  const svg=d3.select('#tree_div').html('').append('svg')
    .attr('preserveAspectRatio','xMinYMin meet');
  const gZoom=svg.append('g'), g=gZoom.append('g');
  const tooltip=g.append('text').attr('class','tooltip').style('display','none');

  // zoom controls
  const zoomBehavior=d3.zoom().scaleExtent([0.5,2]).on('zoom',({transform})=>gZoom.attr('transform',transform));
  svg.call(zoomBehavior);
  const zoomStep=1.25;
  d3.select('#btnZoomIn' ).on('click',()=>svg.transition().call(zoomBehavior.scaleBy,zoomStep));
  d3.select('#btnZoomOut').on('click',()=>svg.transition().call(zoomBehavior.scaleBy,1/zoomStep));
  d3.select('#btnReset'  ).on('click',()=>svg.transition().call(zoomBehavior.transform,d3.zoomIdentity));
  window.addEventListener('keydown',e=>{
    if(e.target!==document.body) return;
    if(e.key==='+'||e.key==='=') svg.transition().call(zoomBehavior.scaleBy,zoomStep);
    if(e.key==='-'||e.key==='_') svg.transition().call(zoomBehavior.scaleBy,1/zoomStep);
    if(e.key==='0')             svg.transition().call(zoomBehavior.transform,d3.zoomIdentity);
  });
  function centerView(){
    svg.transition().duration(0).call(zoomBehavior.transform,d3.zoomIdentity);
  }
  window.resetView=centerView;

  // expand / collapse children on box click
  function toggleChildren(event,d){
    if(d.data.gen===2){
      if(d.children){ d._children=d.children; d.children=null; }
      else          { d.children=d._children; d._children=null; }
      update(); centerView();
    }
  }

  // isolate click
  function toggleIsolate(d){
    if(d.data._isolated){
      // undo
      root.descendants().forEach(nd=>nd.data._isolated=false);
      g.selectAll('g.node,path.branch,path.trunk').style('display',null);
      update();
    } else {
      const sibs = (d.parent && d.parent.children) || [];
      const toHide = new Set();
      sibs.forEach(s=>{
        if(s!==d) s.descendants().forEach(nd=>toHide.add(nd.data.id));
      });
      g.selectAll('g.node').filter(nd=>toHide.has(nd.data.id)).style('display','none');
      g.selectAll('path.branch').filter(br=>toHide.has(br.target.data.id)).style('display','none');
      g.selectAll('path.trunk').filter(tr=>toHide.has(tr.data.id)).style('display','none');
      d.data._isolated = true;
    }
  }

  function update(){
    tree(root);

    // compute alignedX for gen-2 trunks
    const alignedX = d3.max(
      root.descendants().filter(d=>(d.children||d._children)?.length),
      d=>{
        const icon = d.data.gender==='f'?' ♀':d.data.gender==='m'?' ♂':'';
        const lbl = d.data.name + icon + ' ' + d.data.id;
        return d.y + Math.max(80,lbl.length*charW+20)/2 + stub;
      }
    );

    // compute baseX for every node, store on d.baseX
    root.descendants().forEach(d=>{
      const icon = d.data.gender==='f'?' ♀':d.data.gender==='m'?' ♂':'';
      const lbl = d.data.name + icon + ' ' + d.data.id;
      const w   = Math.max(80, lbl.length*charW+20);
      if(d.parent){
        const p=d.parent,
              pic = p.data.gender==='f'?' ♀':p.data.gender==='m'?' ♂':'',
              plbl= p.data.name + pic + ' ' + p.data.id,
              pw  = Math.max(80,plbl.length*charW+20),
              px  = p.depth===1 ? alignedX : p.y + pw/2 + stub + (p.depth===0?indent:0),
              ex  = d.depth===1?indent:0;
        d.baseX = px + indent + ex;
      } else {
        d.baseX = d.y - w/2;
      }
    });

    // resize & pan to fit
    const allX= root.descendants().map(d=>d.x),
          allY= root.descendants().map(d=>d.y).concat(alignedX),
          M=100;
    svg.attr('viewBox',[
      0,0,
      Math.max(...allY)-Math.min(...allY)+M*2,
      Math.max(...allX)-Math.min(...allX)+M*2
    ].join(' '));
    g.attr('transform',`translate(${M-Math.min(...allY)},${M-Math.min(...allX)})`);

    // ** stub-zones beneath everything **
    const stubZones = g.selectAll('rect.stub-zone')
      .data(root.descendants(), d=>d.data.id);
    stubZones.join(
      enter => enter.append('rect').attr('class','stub-zone'),
      upd   => upd,
      exit  => exit.remove()
    )
    .attr('x', d=>d.baseX - indent )
    .attr('y', d=>d.x - 12 )
    .attr('width', indent )
    .attr('height', 24 )
    .on('mouseover', d=>{
      tooltip.text('click to isolate this child')
        .attr('x', d.baseX - indent + 2)
        .attr('y', d.x - 20)
        .style('display','block');
    })
    .on('mouseout', ()=>tooltip.style('display','none'))
    .on('click', e=>{
      e.stopPropagation();
      toggleIsolate(d3.select(e.currentTarget).datum());
    });

    // draw trunks
    g.selectAll('path.trunk')
      .data(root.descendants().filter(d=>d.children?.length), d=>d.data.id)
      .join(
        en=>en.append('path').attr('class','trunk'),
        up=>up,
        ex=>ex.remove()
      )
      .attr('d', d=>{
        const icon = d.data.gender==='f'?' ♀':d.data.gender==='m'?' ♂':'';
        const lbl = d.data.name + icon + ' ' + d.data.id;
        const w   = Math.max(80,lbl.length*charW+20);
        const px  = d.y + w/2 + (d.depth===0?indent:0);
        const tx  = d.depth===1?alignedX:px+stub;
        const ys  = d.children.map(c=>c.x);
        return `M${px},${d.x}H${tx}M${tx},${d3.min(ys)}V${d3.max(ys)}`;
      });

    // draw branches
    g.selectAll('path.branch')
      .data(root.links(), d=>d.target.data.id)
      .join(
        en=>en.append('path').attr('class','branch'),
        up=>up,
        ex=>ex.remove()
      )
      .attr('d', d=>{
        const sIcon = d.source.data.gender==='f'?' ♀':d.source.data.gender==='m'?' ♂':'';
        const sLbl  = d.source.data.name + sIcon + ' ' + d.source.data.id;
        const sW    = Math.max(80,sLbl.length*charW+20);
        const sX    = d.source.depth===1
                    ? alignedX
                    : d.source.y + sW/2 + stub + (d.source.depth===0?indent:0);
        const tIcon = d.target.data.gender==='f'?' ♀':d.target.data.gender==='m'?' ♂':'';
        const tLbl  = d.target.data.name + tIcon + ' ' + d.target.data.id;
        const tW    = Math.max(80,tLbl.length*charW+20);
        const cX    = d.target.depth===2
                    ? alignedX
                    : d.target.y + tW/2 + stub;
        const endX  = (d.target.children?.length)? cX : sX+indent;
        return `M${sX},${d.target.x}H${endX}`;
      });

    // draw nodes
    const nodes = g.selectAll('g.node')
      .data(root.descendants(), d=>d.data.id)
      .join(
        en=>{
          const g= en.append('g').attr('class','node');
          g.append('rect').attr('class','node-rect');
          g.append('text');
          return g;
        },
        up=>up,
        ex=>ex.remove()
      );

    nodes.each(function(d){
      const n=this;
      const sel= d3.select(n);
      const icon = d.data.gender==='f'?' ♀':d.data.gender==='m'?' ♂':'';
      const lbl = d.data.name + icon + ' ' + d.data.id;
      const w   = Math.max(80,lbl.length*charW+20);

      // position
      sel.attr('transform',`translate(${d.baseX},${d.x})`);

      // box
      sel.select('rect.node-rect')
        .attr('class',`node-rect gen${d.data.gen} ${d.data.gender==='f'?'female':d.data.gender==='m'?'male':''}${d.data.dod?' deceased':''}`)
        .attr('x',0).attr('y',-12).attr('width',w).attr('height',24)
        .on('click', e=>{ e.stopPropagation(); toggleChildren(e,d); })
        .on('mouseover',()=>{
          const txt = d.data.spouse
                    ? `Spouse(s): ${d.data.spouse}`
                    : 'Spouse(s): none';
          tooltip.text(txt)
            .attr('x', d.baseX + 5)
            .attr('y', d.x - 20)
            .style('display','block');
        })
        .on('mouseout',()=>tooltip.style('display','none'));

      // label
      sel.select('text')
        .attr('class','node-text')
        .attr('x',10).attr('y',0)
        .text(lbl);
    });
  } // end update

  update();

  // toggle Gen-3
  let collapsed=true;
  window.toggleGen3 = ()=>{
    root.descendants().forEach(d=>{
      if(d.data.gen===2){
        if(collapsed && d._children){ d.children=d._children; d._children=null; }
        else if(!collapsed && d.children){ d._children=d.children; d.children=null; }
      }
    });
    collapsed = !collapsed;
    update(); centerView();
  };
})();
</script>
</body>
</html>
