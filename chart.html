<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Kariapper Family Tree – up to 3 generations</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body { margin:0; font-family:Arial,sans-serif }
    h1  { text-align:center; margin:12px 0 }
    #tree_div { width:100%; height:calc(100vh - 50px); overflow:auto }
    .node-rect { fill:#f9f9f9; stroke:#666; stroke-width:1px; rx:4 }
    .node-text { font-size:12px; pointer-events:none;
                  text-anchor:middle; dominant-baseline:central }
    .link      { fill:none; stroke:#999; stroke-width:1px }
  </style>
</head>
<body>
  <h1>Kariapper Family Tree – up to 3 generations Z  </h1>
  <div id="tree_div">Loading…</div>

  <script>
  (async function(){
    // 1) Fetch the entire Master sheet as JSONP (gid=0)
    const sheetID  = '1BE7PJAJs3QxHnOsb1z5cKnGHdjQCR8IksorMcAm7Fx8';
    const sheetGid = '0';
    const url = 
      `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq`
    + `?gid=${sheetGid}&headers=1&tqx=out:json`;

    const raw  = await fetch(url).then(r=>r.text());
    const json = JSON.parse(raw.slice(raw.indexOf('(')+1, raw.lastIndexOf(')')));
    const headers = json.table.cols.map(c=>c.label);
    const rows    = json.table.rows;

    console.log('Headers:', headers);
    console.log('Total rows:', rows.length);

    // 2) Find the columns we need:
    const idIdx     = headers.findIndex(h => /\(dID\)$/.test(h));      // your calculated dID
    const nameIdx   = headers.findIndex(h => h.trim()==='Full Name'); // Full Name
    const genIdx    = headers.findIndex(h => /Generation/i.test(h));  // Generation
    const spouseIdx = headers.findIndex(h => /^Spouse\(s\)$/i.test(h));// “Spouse(s)” in Z

    if (idIdx<0 || nameIdx<0 || genIdx<0 || spouseIdx<0) {
      document.getElementById('tree_div').innerText =
        '❌ Missing one of: dID, Full Name, Generation or Spouse(s) columns.';
      return;
    }
    console.log('Indexes → dID:',idIdx,'Name:',nameIdx,'Gen:',genIdx,'Spouse(s):',spouseIdx);

    // 3) Build a flat array of nodes (only gens 1–3)
    const flat = rows.map(r => {
      const id      = r.c[idIdx]?.v || '';
      const name    = r.c[nameIdx]?.v || '';
      const gen     = Number(r.c[genIdx]?.v);
      const parent  = id.includes('.') ? id.replace(/\.[^.]+$/, '') : '';
      const spouse  = r.c[spouseIdx]?.v || '';
      return { id, name, gen, parent, spouse };
    }).filter(d => d.id && d.name && d.gen >=1 && d.gen <=3);

    console.log('Flat data:', flat);

    // 4) Nest by id
    const byId = {};
    flat.forEach(d => byId[d.id] = {...d, children: []});
    flat.forEach(d => {
      if (d.parent && byId[d.parent]) byId[d.parent].children.push(byId[d.id]);
    });
    const root = byId['ALK'];
    if (!root) {
      document.getElementById('tree_div').innerText =
        '❌ Could not find root “ALK” – check your dID values.';
      return;
    }

    // 5) Create a D3 tree layout (vertical stacking of Gen 3)
    const hierarchyRoot = d3.hierarchy(root, d=>d.children);
    d3.tree().nodeSize([40, 180])(hierarchyRoot);

    // 6) Compute SVG extents
    const all = hierarchyRoot.descendants();
    const xs  = all.map(d=>d.x), ys = all.map(d=>d.y);
    const minX = d3.min(xs), maxX = d3.max(xs);
    const minY = d3.min(ys), maxY = d3.max(ys);
    const width  = maxY - minY + 200;
    const height = maxX - minX + 200;

    // 7) Draw
    const svg = d3.select('#tree_div')
      .html('') // clear “Loading…”
      .append('svg')
      .attr('width',  width)
      .attr('height', height)
      .append('g')
      .attr('transform', `translate(${-minY+100},${-minX+100})`);

    // links
    svg.selectAll('path.link')
      .data(hierarchyRoot.links())
      .join('path')
      .attr('class','link')
      .attr('d', d3.linkHorizontal().x(d=>d.y).y(d=>d.x));

    // nodes
    const nodeG = svg.selectAll('g.node')
      .data(hierarchyRoot.descendants())
      .join('g')
      .attr('transform', d=>`translate(${d.y},${d.x})`);

    // the box
    nodeG.append('rect')
      .attr('class','node-rect')
      .attr('x', -60)
      .attr('y', -12)
      .attr('width', 120)
      .attr('height', 24);

    // name text
    nodeG.append('text')
      .attr('class','node-text')
      .text(d => d.data.name);

    // spouse tooltip
    nodeG.append('title')
      .text(d => d.data.spouse
        ? `Spouse(s): ${d.data.spouse}`
        : d.data.name
      );
  })();
  </script>
</body>
</html>
