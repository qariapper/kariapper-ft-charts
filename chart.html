<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Kariapper Family Tree – up to 3 generations</title>
<style>
    body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:0;text-align:center}
    #chart{margin:40px auto;width:90vw;min-height:70vh}
    .node rect{stroke:#000;stroke-width:.8px;rx:4;ry:4}
    .node text{font-size:18px;dominant-baseline:middle}
    .link{fill:none;stroke:#555;stroke-width:2px}
    button{margin-top:15px;padding:6px 14px;font-size:14px;cursor:pointer}
</style>
</head>
<body>

<h1>Kariapper Family Tree – up to 3 generations----</h1>
<button id="toggle">Toggle Gen-3</button>
<div id="chart"></div>

<!-- ▶️  D3 (hash removed so it always loads) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
// ---------- CONFIG ----------
const SHEET_ID = "1BE7PJAJs3QxHnOsb1z5cKnGHdjQCR8IksorMcAm7Fx8";
const RANGE    = "A:Z";           // whole sheet (index, name, gender … spouse column Z)
const SHOW_GEN = 3;               // depth limit we can toggle
let gen3Visible = true;

// ---------- HELPERS ----------
const genderFill = g => g==="Female" ? "#f8cfe1" : "#cfe1f8",
      genderIcon = g => g==="Female" ? " ♀" : " ♂";

// fetch Google sheet JSON (no API key needed because sheet is public-read)
async function fetchSheet() {
  const url = `https://opensheet.elk.sh/${SHEET_ID}/${RANGE}`;
  return fetch(url).then(r=>r.json());
}

// build simple hierarchy (index “ALK.1.2” > array parts)
function buildTree(rows){
  const root={name:"",children:[]};
  const map={"ALK":root};
  rows.forEach(r=>{
    const idx=r.Index||r["Index #"]||r.index; // column header variations
    if(!idx) return;
    const node={name:r.Name+genderIcon(r.Gender),gender:r.Gender,spouse:r["Spouse(s)"],children:[]};
    map[idx]=node;
    const parentIdx = idx.split(".").slice(0,-1).join(".")||"ALK";
    (map[parentIdx]?.children||root.children).push(node);
  });
  root.name = rows.find(r=>(r.Index||r["Index #"]||r.index)==="ALK")?.Name || "Ahamadu Lebbe Kariapper ♂";
  root.gender="Male";
  return root;
}

// ---------- DRAW ----------
function draw(treeData){
  d3.select("#chart").html("");                     // clear old
  const chartW = document.getElementById("chart").clientWidth;
  const dx=30, dy=220;                              // node size step
  const tree = d3.tree().nodeSize([dx,dy]);
  const root = d3.hierarchy(treeData);
  tree(root);

  const svg = d3.select("#chart").append("svg")
      .attr("width",chartW)
      .attr("height",root.height*dx+160)
      .attr("viewBox",[-dy/2,-40,chartW,root.height*dx+160]);

  // links
  svg.append("g")
     .attr("fill","none").attr("class","link")
    .selectAll("path")
    .data(root.links())
    .join("path")
     .attr("d", d3.linkHorizontal()
           .x(d=>d.y)
           .y(d=>d.x));

  // nodes
  const node = svg.append("g").selectAll("g")
        .data(root.descendants())
        .join("g")
          .attr("class","node")
          .attr("transform",d=>`translate(${d.y},${d.x})`);

  node.append("rect")
      .attr("fill",d=>genderFill(d.data.gender))
      .attr("x",-5)
      .attr("y",-12)
      .attr("height",24)
      .attr("width",d=>d.data.name.length*9+14);     // crude width calc

  node.append("text")
      .attr("x",4)
      .text(d=>d.data.name)
      .append("title")                               // tooltip = spouse(s)
      .text(d=>d.data.spouse ? `Spouse: ${d.data.spouse}` : "No spouse on record");

  // gen-3 toggle behavioural ref
  node.filter(d=>d.depth===SHOW_GEN).classed("g3",true);
  svg.selectAll(".link").filter(d=>d.target.depth===SHOW_GEN).classed("g3",true);

  toggleGen3();   // start expanded
}

// ---------- TOGGLE ----------
function toggleGen3(){
  gen3Visible = !gen3Visible;
  d3.selectAll(".g3")
    .style("display", gen3Visible?null:"none");
}

// ---------- RUN ----------
fetchSheet()
  .then(buildTree)
  .then(draw)
  .catch(err=>console.error("Sheet load/draw error:",err));

document.getElementById("toggle").onclick = toggleGen3;
</script>

</body>
</html>
