<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Kariapper Family Tree – up to 3 generations</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
    body      { font-family: "Segoe UI", system-ui, sans-serif; margin:0; }
    h1        { text-align:center; margin:.75rem 0 0; }
    #buttons  { text-align:center; margin:.25rem 0 1rem; }
    button    { margin:0 .15rem; padding:.15rem .55rem; }
    svg       { width:100%; height:calc(100vh - 120px); cursor:grab; }
    .link     { fill:none; stroke:#6b6b6b; stroke-width:2px; }
    .male     { fill:#d9e7ff; stroke:#406a9d; }
    .female   { fill:#f7d1e5; stroke:#824576; }
    text      { font:14px/1.15 sans-serif; pointer-events:none; }
</style>
</head>
<body>

<h1>Kariapper Family Tree – up to 3 generations nbmnb</h1>
<div id="buttons">
    <button id="toggle">Toggle Gen-3</button>
    <button id="zoomIn">+</button>
    <button id="zoomOut">−</button>
    <button id="reset">Reset</button>
</div>
<svg id="chart"></svg>

<script>
/* ------------------------------------------------------------------
   0. EDIT just this constant → paste your Sheet ID here
       (or the whole CSV URL if you prefer).
-------------------------------------------------------------------*/
const SHEET_CSV =
  "https://docs.google.com/spreadsheets/d/YOUR-SHEET-ID/export?format=csv";

/* ------------------------------------------------------------------
   1.  Pull data & build the tree
-------------------------------------------------------------------*/
d3.csv(SHEET_CSV).then(rows => {
    /*  rows = [{id,parent,name,gender,dID}, …]                   */
    buildChart(rows);
}).catch(err => {
    alert("Could not load the Google-Sheet CSV!\n" + err);
});

/* ------------------------------------------------------------------
   2.  Main drawing routine (identical to previous answer, but in
       a function so we can call it after the async CSV loads)
-------------------------------------------------------------------*/
function buildChart(rows){

    /* ------ D3 stratified tree ----------------------------------*/
    const root = d3.stratify().id(d=>d.id).parentId(d=>d.parent || null)(rows);
    d3.tree().nodeSize([110,250])(root);

    const svg  = d3.select("#chart");
    svg.selectAll("*").remove();           // reset if we redraw
    const zoomLayer = svg.append("g");

    /* -------- Links (trunk + stubs) -----------------------------*/
    zoomLayer.append("g").selectAll("path")
        .data(root.links())
        .enter().append("path")
        .attr("class","link")
        .attr("d", d3.linkHorizontal()
                     .x(d=>d.y)
                     .y(d=>d.x));

    /* -------- Nodes --------------------------------------------*/
    const nodeG = zoomLayer.append("g")
        .selectAll("g")
        .data(root.descendants())
        .enter().append("g")
        .attr("transform",d=>`translate(${d.y},${d.x})`);

    const PAD = 8;

    nodeG.append("text")
         .text(d=>`${d.data.name} ${d.data.gender==='m'?'♂':'♀'} ${d.data.dID}`)
         .each(function(d){ d.w = this.getBBox().width + PAD*2; })
         .attr("x",d=>-d.w/2 + PAD)
         .attr("dy",".35em");

    nodeG.insert("rect","text")
         .attr("x",d=>-d.w/2)
         .attr("y",-16)
         .attr("width",d=>d.w)
         .attr("height",32)
         .attr("rx",4).attr("ry",4)
         .attr("class",d=>d.data.gender==='m'?'male':'female');

    /* -------- Zoom (wheel, trackpad, buttons) ------------------*/
    const zoom = d3.zoom()
         .scaleExtent([0.25,4])
         .on("zoom", e=>zoomLayer.attr("transform",e.transform));

    svg.call(zoom);

    d3.select("#zoomIn").on("click",()=>svg.transition().call(zoom.scaleBy,1.2));
    d3.select("#zoomOut").on("click",()=>svg.transition().call(zoom.scaleBy,0.8));
    d3.select("#reset").on("click",()=>svg.transition().call(zoom.transform,d3.zoomIdentity));

    /* -------- Toggle generation-3 ------------------------------*/
    let showG3 = true;
    d3.select("#toggle").on("click",() =>{
        showG3 = !showG3;
        nodeG.attr("display",d=>(d.depth===2 && !showG3) ? "none":null);
        zoomLayer.selectAll("path.link")
                 .attr("display",d=> (d.target.depth===2 && !showG3)? "none":null);
    });

} // buildChart()
</script>
</body>
</html>
