<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Kariapper FT â€“ 3-Gen Vertical Tree</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body { margin:0; font-family:Arial,sans-serif }
    h1  { text-align:center; margin:12px 0 }
    #tree_div { width:100%; height:calc(100vh - 50px); overflow:auto }
    .node-rect { fill:#f9f9f9; stroke:#666; stroke-width:1px; rx:4 }
    .node-text { font-size:12px; pointer-events:none; text-anchor:middle; dominant-baseline:central }
    .link      { fill:none; stroke:#999; stroke-width:1px }
  </style>
</head>
<body>
  <h1>Kariapper Family Tree â€“ up to 3 generations ---- PULL</h1>
  <div id="tree_div">Loadingâ€¦</div>

  <script>
  (async function(){
    // 1) sheet + column config
    const sheetID   = '1BE7PJAJs3QxHnOsb1z5cKnGHdjQCR8IksorMcAm7Fx8';
    const sheetName = 'Master';
    const idCol     = 'A',   // dID
          parentCol = 'B',   // Father_dID
          nameCol   = 'C',   // FullName
          spouse1   = 'D',   // SpouseF
          spouse2   = 'E',   // SpouseM
          genCol    = 'F';   // Generation

    // 2) build & fetch JSONP
    const tq = `select ${idCol},${parentCol},${nameCol},${spouse1},${spouse2} where ${genCol} <= 3`;
    const url= `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq`
             + `?sheet=${sheetName}&headers=1`
             + `&tq=${encodeURIComponent(tq)}`
             + `&tqx=out:json`;
    let raw = await fetch(url).then(r=>r.text());
    let json = JSON.parse(raw.slice(raw.indexOf('(')+1, raw.lastIndexOf(')')));
    console.log('Cols:', json.table.cols.map(c=>c.label));
    console.log('Rows:', json.table.rows);

    // 3) map nodes by dID
    const rows = json.table.rows;
    const nodesById = {};
    rows.forEach(r=>{
      const [dID, parent, name, sF, sM] = r.c.map(c=>c?.v||'');
      nodesById[dID] = { id:dID, name, spouses:[sF,sM].filter(x=>x).join(', '), children:[] };
    });
    let root = null;
    rows.forEach(r=>{
      const [dID, parent] = r.c.map(c=>c?.v||'');
      if (parent && nodesById[parent]) {
        nodesById[parent].children.push(nodesById[dID]);
      } else if (dID === 'ALK') {
        root = nodesById[dID];
      }
    });

    if (!root) {
      document.getElementById('tree_div').innerText = 
        'ðŸš¨ Could not find root â€œALKâ€ â€“ check your sheet name & Generation filter.';
      return;
    }

    // 4) build d3.hierarchy + tree layout
    const treeData = d3.hierarchy(root, d=>d.children);
    d3.tree().nodeSize([40, 180])(treeData);

    // 5) calc SVG size
    const all = treeData.descendants();
    const xs  = all.map(d=>d.x), ys = all.map(d=>d.y);
    const minX = Math.min(...xs), maxX = Math.max(...xs);
    const minY = Math.min(...ys), maxY = Math.max(...ys);
    const W = maxY - minY + 200, H = maxX - minX + 200;

    // 6) draw
    const svg = d3.select('#tree_div')
      .append('svg')
      .attr('width', W).attr('height', H)
      .append('g')
      .attr('transform', `translate(${-minY+100},${-minX+100})`);

    // links
    svg.selectAll('path.link')
      .data(treeData.links())
      .join('path')
      .attr('class','link')
      .attr('d', d3.linkHorizontal().x(d=>d.y).y(d=>d.x));

    // nodes
    const ng = svg.selectAll('g.node')
      .data(treeData.descendants())
      .join('g')
      .attr('transform', d=>`translate(${d.y},${d.x})`);

    ng.append('rect')
      .attr('class','node-rect')
      .attr('x',-60).attr('y',-12)
      .attr('width',120).attr('height',24);

    ng.append('text')
      .attr('class','node-text')
      .text(d=>d.data.name);

    ng.append('title')
      .text(d=> d.data.spouses 
         ? `Spouse(s): ${d.data.spouses}` 
         : d.data.name );
  })();
  </script>
</body>
</html>
